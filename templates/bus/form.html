{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Bus scolaire - Formulaire{% endblock %}
{% block breadcrumb_items %}
<li class="breadcrumb-item"><a href="{% url 'bus:index' %}">Bus scolaire</a></li>
<li class="breadcrumb-item"><a href="{% url 'bus:liste' %}">Liste</a></li>
<li class="breadcrumb-item active" aria-current="page">Formulaire</li>
{% endblock %}
{% block page_actions %}
<a class="btn btn-outline-secondary" href="{% url 'bus:liste' %}"><i class="fas fa-arrow-left me-1"></i>Retour</a>
{% endblock %}
{% block extra_css %}
<style>
  .form-section { background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.06); }
  .form-section h5 { color: #0d6efd; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #eef2f7; }
  .eleve-info { background: #f8f9fa; border-radius: 8px; padding: 12px 15px; border-left: 4px solid #0d6efd; }
  .required-field { color: #dc3545; }
  .montant-display { font-size: 1.25rem; font-weight: 700; color: #28a745; }
  .help-text { font-size: .85rem; color: #6c757d; }
  .avatar { width: 60px; height: 60px; }
  .avatar img, .avatar .placeholder { width: 60px; height: 60px; border-radius: 50%; }
  .avatar .placeholder { background: #6c757d; display:flex; align-items:center; justify-content:center; color:#fff; }
  .small-label { font-weight: 600; color:#495057; }
  .hint { font-size: .8rem; color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <form method="post" id="busForm">
      {% csrf_token %}
      {{ form.non_field_errors }}

      <!-- Élève -->
      <div class="form-section">
        <h5 class="d-flex align-items-center"><i class="fas fa-user me-2"></i>Élève</h5>

        <div class="row">
          {% if not form.instance.pk and not form.initial.eleve %}
          <!-- Recherche par matricule -->
          <div class="col-md-6 mb-3">
            <label class="form-label small-label">Matricule de l'élève <span class="required-field">*</span></label>
            <div class="input-group">
              <input type="text" id="matriculeInput" class="form-control" placeholder="Ex: 1CE00048" maxlength="20">
              <button type="button" id="rechercherBtn" class="btn btn-outline-primary">
                <i class="fas fa-search"></i> Rechercher
              </button>
            </div>
            <div id="matriculeHelp" class="help-text">Saisissez le matricule puis cliquez sur Rechercher.</div>
            <div id="matriculeError" class="text-danger small" style="display:none;"></div>
          </div>

          <!-- Sélection manuelle alternative (datalist) -->
          <div class="col-md-6 mb-3">
            <label class="form-label small-label">Ou sélectionner manuellement</label>
            <input type="text" id="eleveInput" class="form-control" list="elevesList" placeholder="Tapez: nom, prénom, classe...">
            <datalist id="elevesList">
              {% for e in form.fields.eleve.queryset %}
                <option value="{{ e.prenom }} {{ e.nom }} ({{ e.matricule }}) - {{ e.classe.nom }} / {{ e.classe.ecole.nom }}" data-id="{{ e.id }}"></option>
              {% endfor %}
            </datalist>
            <div class="help-text">Astuce: choisissez depuis la liste si vous ne connaissez pas le matricule.</div>
          </div>

          <!-- Élève sélectionné (infos) -->
          <div class="col-12 mb-2" id="eleveInfoSection" style="display:none;">
            <div class="eleve-info">
              <div class="row align-items-center">
                <div class="col-md-9">
                  <div class="fw-semibold" id="eleveNomPrenom"></div>
                  <div class="text-muted small" id="eleveMatricule"></div>
                  <div class="text-muted small" id="eleveClasse"></div>
                </div>
                <div class="col-md-3 text-end">
                  <div id="elevePhotoContainer" class="avatar">
                    <div class="placeholder"><i class="fas fa-user"></i></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Champ réel masqué pour la soumission -->
          <div class="d-none">{{ form.eleve }}</div>
          <div id="eleveError" class="text-danger small" style="display:none;">Veuillez sélectionner un élève.</div>
          {% else %}
            {{ form.eleve.as_hidden }}
          {% endif %}
        </div>
      </div>

      <!-- Détails abonnement -->
      <div class="form-section">
        <h5 class="d-flex align-items-center"><i class="fas fa-bus me-2"></i>Détails de l'abonnement</h5>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.montant.id_for_label }}">Montant <span class="required-field">*</span></label>
            <div class="input-group">
              {{ form.montant }}
              <span class="input-group-text">GNF</span>
            </div>
            <div id="montantDisplay" class="montant-display mt-1" style="display:none;"></div>
            {% if form.montant.errors %}<div class="text-danger small">{{ form.montant.errors.0 }}</div>{% endif %}
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.periodicite.id_for_label }}">Périodicité</label>
            {{ form.periodicite }}
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.statut.id_for_label }}">Statut</label>
            {{ form.statut }}
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.date_debut.id_for_label }}">Date de début</label>
            {{ form.date_debut }}
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.date_expiration.id_for_label }}">Date d'expiration</label>
            {{ form.date_expiration }}
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.alerte_avant_jours.id_for_label }}">Alerte (jours avant)</label>
            {{ form.alerte_avant_jours }}
          </div>
        </div>
      </div>

      <!-- Logistique -->
      <div class="form-section">
        <h5 class="d-flex align-items-center"><i class="fas fa-route me-2"></i>Logistique</h5>
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label small-label" for="{{ form.zone.id_for_label }}">Zone</label>
            {{ form.zone }}
          </div>
          <div class="col-md-8 mb-3">
            <label class="form-label small-label" for="{{ form.itineraire.id_for_label }}">Itinéraire</label>
            {{ form.itineraire }}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label small-label" for="{{ form.point_arret.id_for_label }}">Point d'arrêt</label>
            {{ form.point_arret }}
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label small-label" for="{{ form.contact_parent.id_for_label }}">Contact parent</label>
            {{ form.contact_parent }}
          </div>
          <div class="col-12 mb-1">
            <label class="form-label small-label" for="{{ form.observations.id_for_label }}">Observations</label>
            {{ form.observations }}
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-between align-items-center">
        <a href="{% url 'bus:liste' %}" class="btn btn-secondary"><i class="fas fa-arrow-left me-2"></i>Annuler</a>
        <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-save me-2"></i>Enregistrer</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  const ajaxEleveInfoUrl = '{% url "paiements:ajax_eleve_info" %}';
  const matriculeInput = document.getElementById('matriculeInput');
  const rechercherBtn = document.getElementById('rechercherBtn');
  const eleveInput = document.getElementById('eleveInput');
  const eleveSelect = document.querySelector('[name="eleve"]');
  const eleveInfoSection = document.getElementById('eleveInfoSection');
  const eleveNomPrenom = document.getElementById('eleveNomPrenom');
  const eleveMatricule = document.getElementById('eleveMatricule');
  const eleveClasse = document.getElementById('eleveClasse');
  const elevePhotoContainer = document.getElementById('elevePhotoContainer');
  const eleveError = document.getElementById('eleveError');
  const matriculeError = document.getElementById('matriculeError');
  const form = document.getElementById('busForm');
  const montantInput = document.getElementById('id_montant');
  const montantDisplay = document.getElementById('montantDisplay');

  function showEleveInfo(data) {
    if (!data || !data.success || !data.eleve) return;
    const e = data.eleve;
    eleveSelect.value = e.id;
    eleveNomPrenom.textContent = `${e.prenom} ${e.nom}`;
    eleveMatricule.textContent = `Matricule : ${e.matricule}`;
    eleveClasse.textContent = `Classe : ${e.classe} - ${e.ecole}`;
    if (e.photo_url) {
      elevePhotoContainer.innerHTML = `<img src="${e.photo_url}" alt="Photo" />`;
    }
    eleveInfoSection.style.display = 'block';
    eleveError && (eleveError.style.display = 'none');
  }

  async function fetchByMatricule(m) {
    try {
      const url = new URL(ajaxEleveInfoUrl, window.location.origin);
      url.searchParams.set('matricule', m.trim());
      const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      const data = await resp.json();
      if (data && data.success) {
        showEleveInfo(data);
        matriculeError && (matriculeError.style.display = 'none');
      } else {
        eleveSelect.value = '';
        eleveInfoSection.style.display = 'none';
        if (matriculeError) {
          matriculeError.textContent = "Aucun élève trouvé pour ce matricule.";
          matriculeError.style.display = 'block';
        }
      }
    } catch (e) {
      if (matriculeError) {
        matriculeError.textContent = "Erreur lors de la recherche. Réessayez.";
        matriculeError.style.display = 'block';
      }
    }
  }

  rechercherBtn && rechercherBtn.addEventListener('click', function() {
    if (matriculeInput && matriculeInput.value.trim()) {
      fetchByMatricule(matriculeInput.value);
    }
  });

  matriculeInput && matriculeInput.addEventListener('keyup', function(e) {
    if (e.key === 'Enter' && matriculeInput.value.trim()) {
      fetchByMatricule(matriculeInput.value);
    }
  });

  // Datalist sélection manuelle
  eleveInput && eleveInput.addEventListener('change', function() {
    const options = Array.from(document.querySelectorAll('#elevesList option'));
    const match = options.find(o => o.value.trim() === eleveInput.value.trim());
    if (match) {
      eleveSelect.value = match.getAttribute('data-id');
      eleveError && (eleveError.style.display = 'none');
      // Essayer de récupérer infos via matricule extrait du texte
      const m = (eleveInput.value.match(/\(([^)]+)\)/) || [null, null])[1];
      if (m) fetchByMatricule(m);
    }
  });

  // Calcul automatique de la date d'expiration
  const periodiciteSelect = document.getElementById('id_periodicite');
  const dateDebutInput = document.getElementById('id_date_debut');
  const dateExpirationInput = document.getElementById('id_date_expiration');

  function calculateExpirationDate() {
    if (!periodiciteSelect || !dateDebutInput || !dateExpirationInput) return;
    
    const periodicite = periodiciteSelect.value;
    const dateDebut = dateDebutInput.value;
    
    if (!periodicite || !dateDebut) return;
    
    const debut = new Date(dateDebut);
    if (isNaN(debut.getTime())) return;
    
    let expiration = new Date(debut);
    
    switch(periodicite) {
      case 'MENSUEL':
        expiration.setMonth(expiration.getMonth() + 1);
        break;
      case 'TRIMESTRIEL':
        expiration.setMonth(expiration.getMonth() + 3);
        break;
      case 'SEMESTRIEL':
        expiration.setMonth(expiration.getMonth() + 6);
        break;
      case 'ANNUEL':
        expiration.setFullYear(expiration.getFullYear() + 1);
        break;
      default:
        return;
    }
    
    // Format YYYY-MM-DD pour l'input date
    const year = expiration.getFullYear();
    const month = String(expiration.getMonth() + 1).padStart(2, '0');
    const day = String(expiration.getDate()).padStart(2, '0');
    
    dateExpirationInput.value = `${year}-${month}-${day}`;
  }

  // Écouter les changements de périodicité et date de début
  if (periodiciteSelect) {
    periodiciteSelect.addEventListener('change', calculateExpirationDate);
  }
  if (dateDebutInput) {
    dateDebutInput.addEventListener('change', calculateExpirationDate);
  }

  // Affichage du montant formaté
  if (montantInput) {
    const updateMontant = () => {
      const v = parseFloat(montantInput.value);
      if (!isNaN(v) && v > 0) {
        try { montantDisplay.textContent = v.toLocaleString('fr-FR') + ' GNF'; } catch(_) { montantDisplay.textContent = v + ' GNF'; }
        montantDisplay.style.display = 'block';
      } else {
        montantDisplay.style.display = 'none';
      }
    };
    montantInput.addEventListener('input', updateMontant);
    updateMontant();
  }

  // Validation élève à la soumission
  form && form.addEventListener('submit', function(e) {
    if (!eleveSelect || !eleveSelect.value) {
      e.preventDefault();
      if (eleveError) { eleveError.textContent = 'Veuillez sélectionner un élève.'; eleveError.style.display = 'block'; }
      if (matriculeInput) matriculeInput.focus();
      return false;
    }
  });
});
</script>
{% endblock %}
