{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block page_actions %}
<div>
  <a href="{% url 'paiements:ajouter_paiement' %}" class="btn btn-primary">
    <i class="fas fa-plus me-1"></i>Nouveau Paiement
  </a>
  <a href="{% url 'paiements:liste_paiements' %}" class="btn btn-outline-info">
    <i class="fas fa-list me-1"></i>Tous les Paiements
  </a>
  <a href="{% url 'paiements:liste_eleves_soldes' %}" class="btn btn-outline-success">
    <i class="fas fa-check-circle me-1"></i>Élèves soldés
  </a>
  <a href="{% url 'paiements:liste_relances' %}" class="btn btn-outline-warning">
    <i class="fas fa-bell me-1"></i>Relances
  </a>
  {% if perms.utilisateurs.peut_consulter_rapports %}
  <a href="{% url 'paiements:rapport_remises' %}" class="btn btn-outline-success">
    <i class="fas fa-percent me-1"></i>Rapport des remises
  </a>
  {% endif %}
  <a href="{% url 'paiements:tableau_bord' %}" class="btn btn-secondary">
    <i class="fas fa-chart-line me-1"></i>Tableau de bord
  </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Élèves soldés ({{ annee }})</h4>
    <a class="btn btn-secondary" href="{% url 'paiements:tableau_bord' %}">Retour tableau de bord</a>
  </div>

  <form method="get" class="card card-body mb-3">
    <div class="row g-2">
      <div class="col-sm-3">
        <label class="form-label">Année scolaire</label>
        <select name="annee" class="form-select">
          {% for a in annees_options %}
            <option value="{{ a }}" {% if a == annee %}selected{% endif %}>{{ a }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-3">
        <label class="form-label">École</label>
        <select name="ecole_id" class="form-select">
          <option value="">Toutes les écoles</option>
          {% for e in ecoles %}
            <option value="{{ e.id }}" {% if e.id|stringformat:'s' == ecole_id|stringformat:'s' %}selected{% endif %}>{{ e.nom }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-3">
        <label class="form-label">Classe</label>
        <select name="classe_id" class="form-select">
          <option value="">Toutes les classes</option>
          {% for c in classes %}
            <option value="{{ c.id }}" {% if c.id|stringformat:'s' == classe_id|stringformat:'s' %}selected{% endif %}>{{ c.nom }} — {{ c.ecole.nom }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-sm-3">
        <label class="form-label">Recherche</label>
        <input type="text" name="q" value="{{ q }}" class="form-control" placeholder="Nom ou matricule" />
      </div>
    </div>
    <div class="mt-2">
      <button class="btn btn-primary">Filtrer</button>
    </div>
  </form>

  <div class="alert alert-info">
    Période: du {{ periode_debut|date:'d/m/Y' }} au {{ periode_fin|date:'d/m/Y' }}
  </div>

  <div class="row g-3 mb-3">
    <div class="col-sm-3">
      <div class="card text-bg-light">
        <div class="card-body py-2">
          <div class="small text-muted">Total dû</div>
          <div class="fs-5 fw-bold">{{ totaux.du|default:0|floatformat:0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-bg-light">
        <div class="card-body py-2">
          <div class="small text-muted">Total payé</div>
          <div class="fs-5 fw-bold">{{ totaux.paye|default:0|floatformat:0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-bg-light">
        <div class="card-body py-2">
          <div class="small text-muted">Solde</div>
          <div class="fs-5 fw-bold">{{ totaux.solde|default:0|floatformat:0 }}</div>
        </div>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="card text-bg-light">
        <div class="card-body py-2">
          <div class="small text-muted">Total remises</div>
          <div class="fs-5 fw-bold">{{ totaux.remises|default:0|floatformat:0 }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover mb-0">
          <thead>
            <tr>
              <th>#</th>
              <th>Élève</th>
              <th>Matricule</th>
              <th>Classe</th>
              <th>École</th>
              <th>Total dû</th>
              <th>Total payé</th>
              <th>Solde</th>
              <th>Total remises</th>
            </tr>
          </thead>
          <tbody>
            {% for ech in page_obj %}
              <tr>
                <td>{{ forloop.counter0|add:page_obj.start_index }}</td>
                <td>{{ ech.eleve.prenom }} {{ ech.eleve.nom }}</td>
                <td>{{ ech.eleve.matricule }}</td>
                <td>{{ ech.eleve.classe.nom }}</td>
                <td>{{ ech.eleve.classe.ecole.nom }}</td>
                <td>{{ ech.total_du_calc|floatformat:0 }}</td>
                <td>{{ ech.total_paye_calc|floatformat:0 }}</td>
                <td>
                  {% if ech.solde_calcule <= 0 %}
                    <span class="badge bg-success">0</span>
                  {% else %}
                    {{ ech.solde_calcule|floatformat:0 }}
                  {% endif %}
                </td>
                <td>{{ ech.total_remises_calc|default:0|floatformat:0 }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted">Aucun élève trouvé.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination">
      {% if page_obj.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}&annee={{ annee }}&ecole_id={{ ecole_id }}&classe_id={{ classe_id }}&q={{ q }}">Précédent</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Précédent</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
      {% if page_obj.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}&annee={{ annee }}&ecole_id={{ ecole_id }}&classe_id={{ classe_id }}&q={{ q }}">Suivant</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Suivant</span></li>
      {% endif %}
    </ul>
  </nav>
</div>
<script>
  (function() {
    const anneeSelect = document.querySelector('select[name="annee"]');
    const ecoleSelect = document.querySelector('select[name="ecole_id"]');
    const classeSelect = document.querySelector('select[name="classe_id"]');
    const ajaxUrl = "{% url 'paiements:ajax_classes_par_ecole' %}";

    async function loadClasses() {
      const annee = anneeSelect ? anneeSelect.value : '';
      const ecoleId = ecoleSelect ? ecoleSelect.value : '';
      const selected = classeSelect ? classeSelect.value : '';
      if (!classeSelect) return;

      // Build URL with params
      const url = new URL(ajaxUrl, window.location.origin);
      if (ecoleId) url.searchParams.set('ecole_id', ecoleId);
      if (annee) url.searchParams.set('annee', annee);

      // Disable while loading
      classeSelect.disabled = true;
      classeSelect.innerHTML = '<option value="">Chargement…</option>';

      try {
        const resp = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } });
        const data = await resp.json();
        classeSelect.innerHTML = '<option value="">Toutes les classes</option>';
        if (data && data.success && Array.isArray(data.classes)) {
          data.classes.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.nom + (c.ecole_nom ? ' — ' + c.ecole_nom : '');
            classeSelect.appendChild(opt);
          });
          // Restore selection if still present
          if (selected) {
            const has = Array.from(classeSelect.options).some(o => o.value === selected);
            if (has) classeSelect.value = selected;
          }
        }
      } catch (e) {
        console.error('Erreur chargement classes', e);
        classeSelect.innerHTML = '<option value="">Toutes les classes</option>';
      } finally {
        classeSelect.disabled = false;
      }
    }

    if (anneeSelect) anneeSelect.addEventListener('change', loadClasses);
    if (ecoleSelect) ecoleSelect.addEventListener('change', loadClasses);
  })();
</script>
{% endblock %}
