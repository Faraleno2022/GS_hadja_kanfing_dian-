{% extends 'base.html' %}
{% load static %}

{% block title %}Liste des Rapports{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary mb-1">
                <i class="fas fa-list me-2"></i>Liste des Rapports
            </h2>
            <p class="text-muted mb-0">Historique complet de tous les rapports générés</p>
        </div>
        <div class="d-flex gap-2">
            <a href="{% url 'rapports:tableau_bord' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>Retour au tableau de bord
            </a>
            <button class="btn btn-primary" onclick="window.location.reload()">
                <i class="fas fa-sync-alt me-1"></i>Actualiser
            </button>
        </div>
    </div>

    <!-- Filtres -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="filtreType" class="form-label">Type de rapport</label>
                        <select class="form-select" id="filtreType" onchange="filtrerRapports()">
                            <option value="">Tous les types</option>
                            <option value="JOURNALIER">Journalier</option>
                            <option value="HEBDOMADAIRE">Hebdomadaire</option>
                            <option value="MENSUEL">Mensuel</option>
                            <option value="ANNUEL">Annuel</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="filtreStatut" class="form-label">Statut</label>
                        <select class="form-select" id="filtreStatut" onchange="filtrerRapports()">
                            <option value="">Tous les statuts</option>
                            <option value="TERMINE">Terminé</option>
                            <option value="EN_COURS">En cours</option>
                            <option value="ERREUR">Erreur</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="filtreDateDebut" class="form-label">Date début</label>
                        <input type="date" class="form-control" id="filtreDateDebut" onchange="filtrerRapports()">
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="mb-3">
                        <label for="filtreDateFin" class="form-label">Date fin</label>
                        <input type="date" class="form-control" id="filtreDateFin" onchange="filtrerRapports()">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des rapports -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-file-alt me-2"></i>Rapports Générés
                <span class="badge bg-primary ms-2" id="nombreRapports">{{ rapports|length }}</span>
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-success" onclick="exporterListeRapports()">
                    <i class="fas fa-file-csv me-1"></i>CSV
                </button>
                <button class="btn btn-sm btn-success" onclick="exporterListeRapportsExcel()">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
            </div>
        </div>
        <div class="card-body">
            {% if rapports %}
                <div class="table-responsive">
                    <table class="table table-hover" id="tableRapports">
                        <thead class="table-light">
                            <tr>
                                <th>
                                    <i class="fas fa-file-alt me-1"></i>Titre
                                </th>
                                <th>
                                    <i class="fas fa-tag me-1"></i>Type
                                </th>
                                <th>
                                    <i class="fas fa-calendar me-1"></i>Période
                                </th>
                                <th>
                                    <i class="fas fa-clock me-1"></i>Date génération
                                </th>
                                <th>
                                    <i class="fas fa-info-circle me-1"></i>Statut
                                </th>
                                <th>
                                    <i class="fas fa-file-pdf me-1"></i>Format
                                </th>
                                <th class="text-center">
                                    <i class="fas fa-cogs me-1"></i>Actions
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rapport in rapports %}
                            <tr data-type="{{ rapport.type_rapport.nom }}" data-statut="{{ rapport.statut }}" data-date="{{ rapport.date_generation|date:'Y-m-d' }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        <div>
                                            <strong>{{ rapport.titre }}</strong>
                                            {% if rapport.description %}
                                                <br><small class="text-muted">{{ rapport.description|truncatechars:50 }}</small>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if rapport.type_rapport.nom == 'JOURNALIER' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-calendar-day me-1"></i>Journalier
                                        </span>
                                    {% elif rapport.type_rapport.nom == 'HEBDOMADAIRE' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-calendar-week me-1"></i>Hebdomadaire
                                        </span>
                                    {% elif rapport.type_rapport.nom == 'MENSUEL' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-calendar-alt me-1"></i>Mensuel
                                        </span>
                                    {% elif rapport.type_rapport.nom == 'ANNUEL' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-calendar me-1"></i>Annuel
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ rapport.type_rapport.nom }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-nowrap">
                                        <small class="text-muted">Du</small> {{ rapport.periode_debut|date:"d/m/Y" }}<br>
                                        <small class="text-muted">Au</small> {{ rapport.periode_fin|date:"d/m/Y" }}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-nowrap">
                                        {{ rapport.date_generation|date:"d/m/Y" }}<br>
                                        <small class="text-muted">{{ rapport.date_generation|date:"H:i" }}</small>
                                    </div>
                                </td>
                                <td>
                                    {% if rapport.statut == 'TERMINE' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle me-1"></i>Terminé
                                        </span>
                                    {% elif rapport.statut == 'EN_COURS' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-spinner me-1"></i>En cours
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Erreur
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-file-pdf me-1"></i>{{ rapport.format_fichier }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        {% if rapport.statut == 'TERMINE' %}
                                            <button class="btn btn-sm btn-primary" onclick="telechargerRapport({{ rapport.id }})" title="Télécharger">
                                                <i class="fas fa-download"></i>
                                            </button>
                                            <button class="btn btn-sm btn-info" onclick="previsualiserRapport({{ rapport.id }})" title="Prévisualiser">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        {% endif %}
                                        <button class="btn btn-sm btn-secondary" onclick="voirDetailsRapport({{ rapport.id }})" title="Détails">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="supprimerRapport({{ rapport.id }})" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Pagination si nécessaire -->
                <nav aria-label="Navigation des rapports" class="mt-3">
                    <ul class="pagination justify-content-center">
                        <li class="page-item disabled">
                            <span class="page-link">Précédent</span>
                        </li>
                        <li class="page-item active">
                            <span class="page-link">1</span>
                        </li>
                        <li class="page-item disabled">
                            <span class="page-link">Suivant</span>
                        </li>
                    </ul>
                </nav>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-file-alt fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Aucun rapport généré</h4>
                    <p class="text-muted">Commencez par générer votre premier rapport depuis le tableau de bord</p>
                    <a href="{% url 'rapports:tableau_bord' %}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Générer un rapport
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script>
function filtrerRapports() {
    const type = document.getElementById('filtreType').value;
    const statut = document.getElementById('filtreStatut').value;
    const dateDebut = document.getElementById('filtreDateDebut').value;
    const dateFin = document.getElementById('filtreDateFin').value;
    
    const rows = document.querySelectorAll('#tableRapports tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        let visible = true;
        
        // Filtrer par type
        if (type && row.dataset.type !== type) {
            visible = false;
        }
        
        // Filtrer par statut
        if (statut && row.dataset.statut !== statut) {
            visible = false;
        }
        
        // Filtrer par date
        if (dateDebut && row.dataset.date < dateDebut) {
            visible = false;
        }
        if (dateFin && row.dataset.date > dateFin) {
            visible = false;
        }
        
        row.style.display = visible ? '' : 'none';
        if (visible) visibleCount++;
    });
    
    document.getElementById('nombreRapports').textContent = visibleCount;
}

function telechargerRapport(rapportId) {
    // Logique pour télécharger le rapport
    window.open(`/media/rapports/rapport_${rapportId}.pdf`, '_blank');
}

function previsualiserRapport(rapportId) {
    // Logique pour prévisualiser le rapport
    window.open(`/media/rapports/rapport_${rapportId}.pdf`, '_blank');
}

function voirDetailsRapport(rapportId) {
    // Logique pour voir les détails du rapport
    alert(`Détails du rapport ${rapportId} - Fonctionnalité à implémenter`);
}

function supprimerRapport(rapportId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer ce rapport ? Cette action est irréversible.')) {
        // Logique pour supprimer le rapport
        alert(`Suppression du rapport ${rapportId} - Fonctionnalité à implémenter`);
    }
}

function exporterListeRapports() {
    // Export CSV du tableau des rapports (lignes visibles après filtres)
    const table = document.getElementById('tableRapports');
    if (!table) return;

    const rows = Array.from(table.querySelectorAll('thead tr, tbody tr'))
      .filter(tr => tr.closest('thead') || tr.style.display !== 'none');

    const csv = rows.map(tr => {
        const cells = Array.from(tr.children).map(td => {
            // Extraire un texte lisible (sans icônes)
            let text = td.innerText.replace(/\s+/g, ' ').trim();
            // Échapper les guillemets
            text = '"' + text.replace(/"/g, '""') + '"';
            return text;
        });
        return cells.join(',');
    }).join('\n');

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const date = new Date().toISOString().split('T')[0];
    a.href = url;
    a.download = `rapports_${date}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// Initialiser les filtres avec les valeurs par défaut
document.addEventListener('DOMContentLoaded', function() {
    // Définir la date de fin par défaut à aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('filtreDateFin').value = today;
    
    // Définir la date de début par défaut à il y a 30 jours
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
    document.getElementById('filtreDateDebut').value = thirtyDaysAgo.toISOString().split('T')[0];
});
</script>
{% endblock %}
