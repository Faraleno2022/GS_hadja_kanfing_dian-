{% extends 'base.html' %}
{% load static %}

{% block title %}Rapport des remises - {{ periode_str }}{% endblock %}

{% block extra_css %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }
    .remise-item {
        border-left: 4px solid #007bff;
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 5px;
    }
    .montant-remise {
        color: #dc3545;
        font-weight: bold;
        font-size: 1.1em;
    }
    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-percentage me-2"></i>
                        Rapport détaillé des remises {{ periode_str }}
                    </h5>
                    <div>
                        <a href="{% url 'rapports:tableau_bord' %}" class="btn btn-secondary btn-sm">
                            <i class="fas fa-arrow-left me-1"></i>Retour
                        </a>
                        <button class="btn btn-primary btn-sm" onclick="window.print()">
                            <i class="fas fa-print me-1"></i>Imprimer
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Filtres de période -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <form method="get" class="row g-3">
                                <div class="col-md-4">
                                    <label for="date_debut" class="form-label">Date de début</label>
                                    <input type="date" class="form-control" id="date_debut" name="date_debut" 
                                           value="{{ date_debut|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label for="date_fin" class="form-label">Date de fin</label>
                                    <input type="date" class="form-control" id="date_fin" name="date_fin" 
                                           value="{{ date_fin|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="submit" class="btn btn-primary d-block">
                                        <i class="fas fa-search me-1"></i>Filtrer
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Statistiques globales -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card text-center">
                                <h3 class="mb-1">{{ stats_remises.total_remises|floatformat:0 }} GNF</h3>
                                <p class="mb-0">Total des remises accordées</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card text-center">
                                <h3 class="mb-1">{{ stats_remises.nombre_paiements_avec_remise }}</h3>
                                <p class="mb-0">Paiements avec remises</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card text-center">
                                <h3 class="mb-1">{{ stats_remises.nombre_eleves_beneficiaires }}</h3>
                                <p class="mb-0">Élèves bénéficiaires</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Répartition par type de remise -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="mb-3">
                                    <i class="fas fa-chart-pie me-2"></i>Répartition par type de remise
                                </h6>
                                {% if repartition_types %}
                                    {% for type in repartition_types %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>{{ type.remise__nom }}</strong>
                                            <br><small class="text-muted">{{ type.nombre_applications }} application(s)</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="montant-remise">{{ type.total_montant|floatformat:0 }} GNF</span>
                                        </div>
                                    </div>
                                    <div class="progress mb-3" style="height: 6px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {% widthratio type.total_montant stats_remises.total_remises 100 %}%">
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">Aucune remise appliquée dans cette période.</p>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="chart-container">
                                <h6 class="mb-3">
                                    <i class="fas fa-school me-2"></i>Répartition par école
                                </h6>
                                {% if repartition_ecoles %}
                                    {% for ecole in repartition_ecoles %}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div>
                                            <strong>{{ ecole.paiement__eleve__classe__ecole__nom }}</strong>
                                            <br><small class="text-muted">{{ ecole.nombre_applications }} remise(s)</small>
                                        </div>
                                        <div class="text-end">
                                            <span class="montant-remise">{{ ecole.total_montant|floatformat:0 }} GNF</span>
                                        </div>
                                    </div>
                                    <div class="progress mb-3" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" 
                                             style="width: {% widthratio ecole.total_montant stats_remises.total_remises 100 %}%">
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted">Aucune donnée par école disponible.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Liste détaillée des remises -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-list me-2"></i>Détail des remises appliquées
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% if remises_appliquees %}
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>Date</th>
                                                        <th>Élève</th>
                                                        <th>École</th>
                                                        <th>N° Reçu</th>
                                                        <th>Type de remise</th>
                                                        <th>Motif</th>
                                                        <th class="text-end">Montant remise</th>
                                                        <th class="text-end">Montant final</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {% for remise in remises_appliquees %}
                                                    <tr>
                                                        <td>{{ remise.paiement.date_paiement|date:"d/m/Y" }}</td>
                                                        <td>
                                                            <strong>{{ remise.paiement.eleve.nom_complet }}</strong>
                                                            <br><small class="text-muted">{{ remise.paiement.eleve.classe.nom }}</small>
                                                        </td>
                                                        <td>{{ remise.paiement.eleve.classe.ecole.nom }}</td>
                                                        <td>
                                                            <a href="{% url 'paiements:detail_paiement' remise.paiement.id %}" 
                                                               class="text-decoration-none">
                                                                {{ remise.paiement.numero_recu }}
                                                            </a>
                                                        </td>
                                                        <td>{{ remise.remise.nom }}</td>
                                                        <td>
                                                            <span class="badge bg-secondary">
                                                                {{ remise.remise.get_motif_display }}
                                                            </span>
                                                        </td>
                                                        <td class="text-end montant-remise-cell" data-montant="{{ remise.montant_remise }}">
                                                            <span class="montant-remise">
                                                                -{{ remise.montant_remise|floatformat:0 }} GNF
                                                            </span>
                                                        </td>
                                                        <td class="text-end montant-final-cell" data-montant="{{ remise.paiement.montant }}">
                                                            <strong>{{ remise.paiement.montant|floatformat:0 }} GNF</strong>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                                <tfoot class="table-light">
                                                    <tr>
                                                        <th colspan="6" class="text-end">Totaux :</th>
                                                        <th class="text-end">
                                                            <span class="montant-remise" id="total-remises">
                                                                <!-- Calculé par JavaScript -->
                                                            </span>
                                                        </th>
                                                        <th class="text-end">
                                                            <strong id="total-montants-finals">
                                                                <!-- Calculé par JavaScript -->
                                                            </strong>
                                                        </th>
                                                    </tr>
                                                    <tr>
                                                        <th colspan="6" class="text-end">Différence (Final - Remise) :</th>
                                                        <th colspan="2" class="text-end">
                                                            <strong class="text-success" id="difference-totale">
                                                                <!-- Calculé par JavaScript -->
                                                            </strong>
                                                        </th>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    {% else %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Aucune remise appliquée dans la période sélectionnée.
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Formatage automatique des montants pour l'affichage
    const montants = document.querySelectorAll('.montant-remise');
    montants.forEach(function(element) {
        const text = element.textContent.trim();
        if (text.includes('GNF')) {
            const number = text.replace(/[^\d]/g, '');
            if (number) {
                const formatted = parseInt(number).toLocaleString('fr-FR');
                element.textContent = text.replace(/[\d,\s]+/, formatted);
            }
        }
    });
    
    // Calcul des totaux des montants remise et final
    let totalRemises = 0;
    let totalMontantsFinals = 0;
    
    // Calculer total des remises
    const montantRemiseCells = document.querySelectorAll('.montant-remise-cell');
    montantRemiseCells.forEach(function(cell) {
        const montant = parseFloat(cell.getAttribute('data-montant')) || 0;
        totalRemises += montant;
    });
    
    // Calculer total des montants finaux
    const montantFinalCells = document.querySelectorAll('.montant-final-cell');
    montantFinalCells.forEach(function(cell) {
        const montant = parseFloat(cell.getAttribute('data-montant')) || 0;
        totalMontantsFinals += montant;
    });
    
    // Calculer la différence
    const difference = totalMontantsFinals - totalRemises;
    
    // Afficher les totaux
    const totalRemisesElement = document.getElementById('total-remises');
    if (totalRemisesElement) {
        totalRemisesElement.innerHTML = '-' + Math.round(totalRemises).toLocaleString('fr-FR') + ' GNF';
    }
    
    const totalMontantsFinalsElement = document.getElementById('total-montants-finals');
    if (totalMontantsFinalsElement) {
        totalMontantsFinalsElement.innerHTML = Math.round(totalMontantsFinals).toLocaleString('fr-FR') + ' GNF';
    }
    
    const differenceElement = document.getElementById('difference-totale');
    if (differenceElement) {
        differenceElement.innerHTML = Math.round(difference).toLocaleString('fr-FR') + ' GNF';
    }
});
</script>
{% endblock %}
