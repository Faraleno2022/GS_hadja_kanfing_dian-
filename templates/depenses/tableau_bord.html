{% extends 'base.html' %}
{% load humanize %}

{% block title %}Tableau de Bord - Dépenses{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        color: #333;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-color: #ccc;
    }
    .stat-number {
        font-size: 2.2rem;
        font-weight: 600;
        color: #2c3e50;
    }
    .stat-label {
        font-size: 0.9rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    .chart-container {
        background: #ffffff;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .section-title {
        color: #2c3e50;
        border-bottom: 2px solid #6c757d;
        padding-bottom: 8px;
        margin-bottom: 20px;
        font-weight: 600;
    }
    .table-modern {
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        border: 1px solid #e0e0e0;
    }
    .table-modern thead {
        background: #f8f9fa;
        color: #495057;
        border-bottom: 2px solid #e9ecef;
    }
    .badge-status {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
    }
    .alert-retard {
        background-color: #fff3cd;
        border-color: #ffeaa7;
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">Tableau de Bord - Dépenses</h1>
            <p class="text-muted mb-0">Vue d'ensemble des dépenses et de leur gestion</p>
        </div>
        <div>
            <a href="{% url 'depenses:ajouter_depense' %}" class="btn btn-outline-secondary">
                <i class="fas fa-plus"></i> Nouvelle Dépense
            </a>
        </div>
    </div>

    <!-- Statistiques principales -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ total_depenses|intcomma }}</div>
                <div class="stat-label">Total Dépenses</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ depenses_validees|intcomma }}</div>
                <div class="stat-label">Validées</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ depenses_payees|intcomma }}</div>
                <div class="stat-label">Payées</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ depenses_en_attente|intcomma }}</div>
                <div class="stat-label">En Attente</div>
            </div>
        </div>
    </div>

    <!-- Montants -->
    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ montant_total|intcomma }}</div>
                <div class="stat-label">Montant Total (GNF)</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ montant_paye|intcomma }}</div>
                <div class="stat-label">Montant Payé (GNF)</div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="stat-card text-center p-4">
                <div class="stat-number">{{ montant_en_attente|intcomma }}</div>
                <div class="stat-label">En Attente (GNF)</div>
            </div>
        </div>
    </div>

    <!-- Alertes -->
    {% if depenses_en_retard > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-retard">
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Attention !</strong> {{ depenses_en_retard }} dépense{{ depenses_en_retard|pluralize }} en retard de paiement.
                <a href="{% url 'depenses:liste_depenses' %}?retard=1" class="alert-link">Voir les détails</a>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Dépenses récentes -->
        <div class="col-md-8 mb-4">
            <div class="chart-container p-4">
                <h5 class="section-title">
                    <i class="fas fa-clock"></i> Dépenses Récentes
                </h5>
                
                {% if depenses_recentes %}
                <div class="table-responsive">
                    <table class="table table-modern table-hover mb-0">
                        <thead>
                            <tr>
                                <th>N° Facture</th>
                                <th>Libellé</th>
                                <th>Fournisseur</th>
                                <th>Montant</th>
                                <th>Statut</th>
                                <th>Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for depense in depenses_recentes %}
                            <tr>
                                <td>
                                    <a href="{% url 'depenses:detail_depense' depense.id %}" class="text-decoration-none">
                                        {{ depense.numero_facture }}
                                    </a>
                                </td>
                                <td>{{ depense.libelle|truncatechars:30 }}</td>
                                <td>{{ depense.fournisseur.nom|truncatechars:25 }}</td>
                                <td>{{ depense.montant_ttc|intcomma }} GNF</td>
                                <td>
                                    {% if depense.statut == 'BROUILLON' %}
                                        <span class="badge bg-secondary badge-status">Brouillon</span>
                                    {% elif depense.statut == 'EN_ATTENTE' %}
                                        <span class="badge bg-warning badge-status">En attente</span>
                                    {% elif depense.statut == 'VALIDEE' %}
                                        <span class="badge bg-info badge-status">Validée</span>
                                    {% elif depense.statut == 'PAYEE' %}
                                        <span class="badge bg-success badge-status">Payée</span>
                                    {% elif depense.statut == 'REJETEE' %}
                                        <span class="badge bg-danger badge-status">Rejetée</span>
                                    {% elif depense.statut == 'ANNULEE' %}
                                        <span class="badge bg-dark badge-status">Annulée</span>
                                    {% endif %}
                                </td>
                                <td>{{ depense.date_creation|date:"d/m/Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="text-center mt-3">
                    <a href="{% url 'depenses:liste_depenses' %}" class="btn btn-outline-secondary btn-sm">
                        Voir toutes les dépenses
                    </a>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Aucune dépense enregistrée</p>
                    <a href="{% url 'depenses:ajouter_depense' %}" class="btn btn-outline-secondary">
                        Ajouter la première dépense
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Statistiques par catégorie -->
        <div class="col-md-4 mb-4">
            <div class="chart-container p-4">
                <h5 class="section-title">
                    <i class="fas fa-chart-pie"></i> Par Catégorie
                </h5>
                
                {% if stats_categories %}
                <div class="list-group list-group-flush">
                    {% for categorie in stats_categories %}
                    <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                        <div>
                            <strong>{{ categorie.nom }}</strong>
                            <br>
                            <small class="text-muted">{{ categorie.nb_depenses }} dépense{{ categorie.nb_depenses|pluralize }}</small>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold">{{ categorie.montant_total|default:0|intcomma }} GNF</div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tags fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Aucune catégorie configurée</p>
                    <a href="{% url 'depenses:gestion_categories' %}" class="btn btn-outline-secondary btn-sm">
                        Gérer les catégories
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="chart-container p-4">
                <h5 class="section-title">
                    <i class="fas fa-tools"></i> Actions Rapides
                </h5>
                <div class="row">
                    <div class="col-md-3">
                        <a href="{% url 'depenses:ajouter_depense' %}" class="btn btn-outline-secondary btn-block mb-2">
                            <i class="fas fa-plus"></i> Nouvelle Dépense
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'depenses:liste_depenses' %}" class="btn btn-outline-secondary btn-block mb-2">
                            <i class="fas fa-list"></i> Liste des Dépenses
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'depenses:gestion_categories' %}" class="btn btn-outline-secondary btn-block mb-2">
                            <i class="fas fa-tags"></i> Gérer Catégories
                        </a>
                    </div>
                    <div class="col-md-3">
                        <a href="{% url 'depenses:gestion_fournisseurs' %}" class="btn btn-outline-secondary btn-block mb-2">
                            <i class="fas fa-truck"></i> Gérer Fournisseurs
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Animation des cartes au chargement
    document.addEventListener('DOMContentLoaded', function() {
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 100);
        });

        // Animation des nombres
        const numbers = document.querySelectorAll('.stat-number');
        numbers.forEach(number => {
            const finalValue = parseInt(number.textContent.replace(/\s/g, ''));
            if (!isNaN(finalValue) && finalValue > 0) {
                let currentValue = 0;
                const increment = finalValue / 30;
                const timer = setInterval(() => {
                    currentValue += increment;
                    if (currentValue >= finalValue) {
                        number.textContent = finalValue.toLocaleString('fr-FR');
                        clearInterval(timer);
                    } else {
                        number.textContent = Math.floor(currentValue).toLocaleString('fr-FR');
                    }
                }, 50);
            }
        });
    });
</script>
{% endblock %}
